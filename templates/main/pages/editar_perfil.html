{% extends "shared/pages/base.html" %}
{% block subtitulo %}Editar{% endblock %}
{% block conteudo %}
<link rel="stylesheet" href="/static/css/estilo_editar_perfil.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<div class="container mt-4">
    <a href="/configuracoes" class="text-decoration-none text-black">
        <i class="bi bi-caret-left-fill fs-5"></i>
        <span class="fs-5">Perfil</span>
    </a>
</div>

<!-- Modal para cortar a imagem -->

<!-- Início do formulário -->
<form action="/atualizar_perfil" method="POST" enctype="multipart/form-data">
    <div class="container text-center mt-4 bg-highlight">
        <h3>Editar perfil</h3>
    
        <div class="--bg-tertiary-color rounded d-flex flex-column align-items-center justify-content-center bg-highlight">
            <div class="d-flex align-items-center mb-3 bg-highlight">
                <img id="fotoPerfil" src="static/img/{{usuario.id}}.jpeg" alt="Foto de Perfil" class="rounded-circle mb-3" style="width: 100px; height: 100px;">
            </div>
            <button type="button" id="alterarFoto" class="btn btn-primary" style="border-radius: 20px; background-color: #0F6481;">Alterar Foto</button>
            <input type="file" id="inputFoto" name="foto_perfil" accept="image/*" style="display: none;">
            <!-- Campo oculto para a imagem cortada -->
            <input type="hidden" name="foto_perfil_blob" id="foto_perfil_blob">
        </div>
    </div>
    <div id="modalCortar" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cortar Foto</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <img id="imagemParaCorte" src="" alt="Imagem para Cortar" style="max-width: 100%;">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" id="salvarCorte" class="btn btn-primary">Salvar</button>
                </div>
            </div>
        </div>
    </div>
    <input type="hidden" name="email_atual" value="{{ usuario.email }}">
    <div class="mb-3 bg-highlight">
        <label for="Nome" class="form-label">Nome</label>
        <input type="text" name="nome" class="form-control" id="nome" value="{{ usuario.nome or '' }}" 
               placeholder="{{ usuario.nome or 'Nome' }}" required
               onfocus="clearValue(this, '{{ usuario.nome or 'Nome' }}')"
               onblur="restoreValue(this, '{{ usuario.nome or 'Nome' }}')">
    </div>

    <div class="mb-3 bg-highlight">
        <label for="NomePerfil" class="form-label">Nome do Perfil</label>
        <input type="text" name="nome_perfil" class="form-control" id="nome_perfil" value="{{ usuario.nome_perfil or '' }}" 
               placeholder="{{ usuario.nome_perfil or 'Nome de Perfil' }}" required
               onfocus="clearValue(this, '{{ usuario.nome_perfil or 'Nome de Perfil' }}')"
               onblur="restoreValue(this, '{{ usuario.nome_perfil or 'Nome de Perfil' }}')">
    </div>    

    <div class="mb-3 bg-highlight">
        <label for="Email" class="form-label">Email</label>
        <input type="email" name="email" class="form-control" id="email" value="{{ usuario.email or '' }}" 
               placeholder="{{ usuario.email or 'Email' }}" required
               onfocus="clearValue(this, '{{ usuario.email or 'Email' }}')"
               onblur="restoreValue(this, '{{ usuario.email or 'Email' }}')">
    </div>

    <div class="mb-3 bg-highlight">
        <label for="Telefone" class="form-label">Telefone</label>
        <input type="text" name="telefone" class="form-control" id="telefone" value="{{ usuario.telefone or '' }}" 
               placeholder="{{ usuario.telefone or 'Telefone' }}" required
               onfocus="clearValue(this, '{{ usuario.telefone or 'Telefone' }}')"
               onblur="restoreValue(this, '{{ usuario.telefone or 'Telefone' }}')">
    </div>

    <div class="mb-3 bg-highlight">
        <label for="Bio" class="form-label">Bio</label>
        <textarea name="bio_perfil" class="form-control" id="bio" rows="2"
                  placeholder="{{ usuario.bio_perfil or 'Bio' }}" required
                  onfocus="clearValue(this, '{{ usuario.bio_perfil or 'Bio' }}')"
                  onblur="restoreValue(this, '{{ usuario.bio_perfil or 'Bio' }}')">{{ usuario.bio_perfil }}</textarea>
    </div>

    <div class="mb-3 bg-highlight">
        <label for="Genero" class="form-label">Gênero</label>
        <select name="genero" id="genero" class="form-select" required>
            <option value="" disabled {{ usuario.genero is none and 'selected' }}>Selecione o gênero</option>
            <option value="fem" {{ usuario.genero == 'fem' and 'selected' }}>Feminino</option>
            <option value="mas" {{ usuario.genero == 'mas' and 'selected' }}>Masculino</option>
            <option value="per" {{ usuario.genero == 'per' and 'selected' }}>Personalizado</option>
            <option value="pno" {{ usuario.genero == 'pno' and 'selected' }}>Prefiro não opinar</option>
        </select> 
    </div>
    
    <div class="text-center">
        <button type="submit" class="btn btn-primary mt-3" style="border-radius: 20px; background-color: #0F6481;">Enviar</button>
    </div>
</form>
<!-- Fim do formulário -->

<script>
    let cropper;

    document.getElementById('alterarFoto').addEventListener('click', function(event) {
        event.preventDefault();
        document.getElementById('inputFoto').click();
    });

    document.getElementById('inputFoto').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('imagemParaCorte');
                img.src = e.target.result;
                $('#modalCortar').modal('show'); // Mostrar modal ao carregar a imagem
                if (cropper) {
                    cropper.destroy();
                }
                cropper = new Cropper(img, {
                    aspectRatio: 1,
                    viewMode: 1,
                });
            }
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('salvarCorte').addEventListener('click', function() {
        const canvas = cropper.getCroppedCanvas({
            // Você pode remover essas linhas para usar a resolução original
            // width: 100,
            // height: 100,
        });
    
        // Convertendo a imagem cortada para um Blob
        canvas.toBlob(function(blob) {
            const url = URL.createObjectURL(blob);
            document.getElementById('fotoPerfil').src = url; 
            const fileInput = document.getElementById('foto_perfil_blob');
    
            // Criar um novo File para enviar com o formulário
            const reader = new FileReader();
            reader.readAsDataURL(blob); // Ler o Blob como Data URL
            reader.onloadend = function() {
                fileInput.value = reader.result; // Armazenar o Data URL no campo oculto
            };
    
            $('#modalCortar').modal('hide');
        }, 'image/png', 0.9); // Aumente a qualidade para 0.9 (90%)
    });

    // Atualizar o evento de envio do formulário
    document.querySelector('form').addEventListener('submit', function(event) {
        const croppedImageBlob = document.getElementById('foto_perfil_blob').files.length;
        if (croppedImageBlob === 0) {
            alert("Por favor, corte e salve a imagem antes de enviar.");
            event.preventDefault();
        }
    });

    function clearValue(input, placeholder) {
        if (input.value === placeholder) {
            input.value = '';
        }
    }

    function restoreValue(input, placeholder) {
        if (input.value === '') {
            input.value = placeholder;
        }
    }
</script>
{% endblock %}
